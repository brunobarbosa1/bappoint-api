package com.wesleysilva.bappoint.OffDay;

import com.wesleysilva.bappoint.Company.CompanyModel;
import com.wesleysilva.bappoint.Company.CompanyRepository;
import com.wesleysilva.bappoint.OffDay.dto.CreateOffDayDTO;
import com.wesleysilva.bappoint.OffDay.dto.OffDayUpdateDTO;
import com.wesleysilva.bappoint.OffDay.dto.OffDaysAllDetailsDTO;
import com.wesleysilva.bappoint.OffDay.dto.OffDaysResponseDTO;
import com.wesleysilva.bappoint.OperatingHours.OperatingHoursDTO;
import com.wesleysilva.bappoint.OperatingHours.OperatingHoursModel;
import com.wesleysilva.bappoint.Settings.SettingsModel;
import com.wesleysilva.bappoint.Settings.SettingsRepository;
import com.wesleysilva.bappoint.exceptions.CompanyNotFoundException;
import com.wesleysilva.bappoint.exceptions.OffDayNotFoundException;
import com.wesleysilva.bappoint.exceptions.SettingsNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class OffDaysService {

   private final OffDaysRepository offDaysRepository;
   private final OffDaysMapper offDaysMapper;
   private final SettingsRepository settingsRepository;
   private final CompanyRepository companyRepository;

    public OffDaysService(OffDaysRepository offDaysRepository, OffDaysMapper offDaysMapper, SettingsRepository settingsRepository, CompanyRepository companyRepository) {
        this.offDaysRepository = offDaysRepository;
        this.offDaysMapper = offDaysMapper;
        this.settingsRepository = settingsRepository;
        this.companyRepository = companyRepository;
    }

    @Transactional
    public CreateOffDayDTO createOffDays(UUID companyId, CreateOffDayDTO offDaysDTO) {
        OffDaysModel offDaysModel = offDaysMapper.toEntity(offDaysDTO);

        CompanyModel company = companyRepository.findById(companyId).orElseThrow(CompanyNotFoundException::new);

        SettingsModel settings = company.getSettings();

        if(settings == null) {
            throw new SettingsNotFoundException();
        }

        offDaysModel.setSettings(settings);

        offDaysModel = offDaysRepository.save(offDaysModel);

        return offDaysMapper.toCreate(offDaysModel);
    }

    @Transactional(readOnly = true)
    public List<OffDaysResponseDTO> getAllOffDays(){
        List<OffDaysModel> offDaysModels = offDaysRepository.findAll();
        return offDaysModels.stream()
                .map(offDaysMapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public OffDaysAllDetailsDTO getOffDaysById(UUID offDaysId) {
        OffDaysModel offDayById = offDaysRepository.findById(offDaysId)
                .orElseThrow(OffDayNotFoundException::new);
        return offDaysMapper.toResponseAllDetails(offDayById);
    }

    void deleteOffDaysById(UUID offDaysId) {
        OffDaysModel offDay = offDaysRepository.findById(offDaysId)
                        .orElseThrow(OffDayNotFoundException::new);

        offDaysRepository.delete(offDay);
    }

    public OffDayUpdateDTO updateService(UUID offDaysID, OffDayUpdateDTO offDaysDTO) {
        return offDaysRepository.findById(offDaysID)
                .map(offDaysToUpdate -> {
                    offDaysToUpdate.setOffDaystype(offDaysDTO.getOffDaysType());
                    offDaysToUpdate.setReason(offDaysDTO.getReason());
                    offDaysToUpdate.setDate(offDaysDTO.getDate());
                    return offDaysMapper.toUpdate(offDaysRepository.save(offDaysToUpdate));
                })
                .orElseThrow(OffDayNotFoundException::new);
    }
}
